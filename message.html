<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Messages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="messagePage()" x-init="initPage()" class="min-h-screen text-gray-800 font-sans">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-1/4 border-r border-gray-200 bg-white overflow-y-auto">
      <h2 class="text-xl font-semibold p-4 border-b">Connections</h2>
      <ul>
        <template x-for="person in people" :key="person.connection_urn">
          <li @click="selectConnection(person)" class="cursor-pointer hover:bg-gray-100 px-4 py-3 flex items-center gap-3"
              :class="{ 'bg-gray-200': selectedConnection?.connection_urn === person.connection_urn }">
            <img :src="clean(person.profile_picture_url)" class="w-8 h-8 rounded-full object-cover" />
            <span x-text="`${clean(person.first_name)} ${clean(person.last_name)}`" class="text-sm font-medium"></span>
          </li>
        </template>
      </ul>
    </div>

    <!-- Chat Panel -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <div class="px-6 py-4 border-b flex items-center gap-4 bg-white">
        <template x-if="selectedConnection">
          <div class="flex items-center gap-4">
            <img :src="clean(selectedConnection.profile_picture_url)" class="w-10 h-10 rounded-full object-cover" />
            <div>
              <div class="text-lg font-semibold" x-text="`${clean(selectedConnection.first_name)} ${clean(selectedConnection.last_name)}`"></div>
              <div class="text-sm text-gray-500" x-text="clean(selectedConnection.headline)"></div>
            </div>
          </div>
        </template>
        <template x-if="!selectedConnection">
          <div class="text-gray-400 text-sm">Select a connection to start chatting</div>
        </template>
      </div>

      <!-- Messages -->
      <div class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
        <template x-for="msg in chatMessages" :key="msg.id">
          <div class="max-w-lg" :class="msg.direction === 'outgoing' ? 'ml-auto text-right' : 'mr-auto text-left'">
            <div class="inline-block px-4 py-2 rounded-lg"
                 :class="msg.direction === 'outgoing' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'">
              <span x-text="msg.text"></span>
            </div>
            <div class="text-xs text-gray-400 mt-1" x-text="msg.timestamp"></div>
          </div>
        </template>
      </div>

      <!-- Input -->
      <div class="p-4 border-t bg-white flex gap-2">
        <input x-model="newMessage" @keydown.enter="sendMessage"
               type="text" placeholder="Type a message..." class="flex-1 px-4 py-2 border rounded-lg text-sm" />
        <button @click="sendMessage"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
          Send
        </button>
      </div>
    </div>
  </div>

  <script>
    function messagePage() {
      return {
        uid: '',
        userId: '',
        people: [],
        selectedConnection: null,
        chatMessages: [],
        newMessage: '',

        initPage() {
          const params = new URLSearchParams(window.location.search);
          this.uid = params.get('uid') || '';
          this.userId = params.get('user_id') || '';

          // Redirect only if uid or userId is missing
          if (!this.uid || !this.userId) {
            window.location.href = 'auth.html';
            return;
          }

          // Load sample/dummy people
          this.people = [
            {
              connection_urn: 'urn:li:fsd_connection:1',
              first_name: 'Alice',
              last_name: 'Johnson',
              profile_picture_url: 'https://via.placeholder.com/80',
              headline: 'Software Engineer'
            },
            {
              connection_urn: 'urn:li:fsd_connection:2',
              first_name: 'Bob',
              last_name: 'Smith',
              profile_picture_url: 'https://via.placeholder.com/80',
              headline: 'Product Manager'
            }
          ];
        },

        selectConnection(person) {
          this.selectedConnection = person;

          // Load dummy chat messages
          this.chatMessages = [
            { id: 1, text: 'Hi there!', timestamp: '10:00 AM', direction: 'incoming' },
            { id: 2, text: 'Hello!', timestamp: '10:01 AM', direction: 'outgoing' }
          ];
        },

        sendMessage() {
          if (!this.newMessage.trim()) return;
          this.chatMessages.push({
            id: Date.now(),
            text: this.newMessage.trim(),
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            direction: 'outgoing'
          });
          this.newMessage = '';
        },

        clean(val) {
          return typeof val === 'string' ? val.replace(/^"+|"+$/g, '').trim() : (val || '');
        }
      };
    }
  </script>
</body>
</html>
