<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Connections</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="connectionsPage()" x-init="initPage()" class="min-h-screen px-4 py-6 text-gray-800 font-sans">

  <div class="max-w-6xl mx-auto space-y-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-3xl font-bold">Connections</h1>
      <a :href="`profile.html?uid=${uid}&user_id=${userId}`" class="text-blue-600 hover:underline text-sm">← Back to Profile</a>
    </div>

    <!-- Retry Button -->
    <div class="text-center" x-show="fetchFailed && !loading">
      <p class="text-gray-500 mb-2">Failed to load connections.</p>
      <button @click="fetchAllConnections(currentPage)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
        Retry
      </button>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="text-center text-gray-500 py-10">Loading connections...</div>
    </template>

    <!-- No Connections -->
    <template x-if="!loading && !fetchFailed && paginatedConnections.length === 0">
      <div class="text-center text-gray-400 py-10">No connections found.</div>
    </template>

    <!-- Table -->
    <template x-if="paginatedConnections.length > 0">
      <div class="overflow-x-auto bg-white shadow border border-gray-200 rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Photo</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">Headline</th>
              <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">LinkedIn</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100 bg-white">
            <template x-for="conn in paginatedConnections" :key="conn.connection_urn">
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <img :src="clean(conn.profile_picture_url)" alt="Profile" class="w-10 h-10 rounded-full object-cover border">
                </td>
                <td class="px-6 py-4 text-sm font-medium" x-text="clean(conn.first_name) + ' ' + clean(conn.last_name)"></td>
                <td class="px-6 py-4 text-sm text-gray-600" x-text="clean(conn.headline) || '—'"></td>
                <td class="px-6 py-4 text-sm">
                  <a :href="clean(conn.public_profile_url)" class="text-blue-500 hover:underline" target="_blank">View</a>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>

    <!-- Pagination -->
    <div class="flex justify-center mt-6 space-x-2" x-show="totalPages > 1 && !fetchFailed">
      <template x-for="page in totalPages" :key="page">
        <button
          @click="goToPage(page)"
          :class="page === currentPage ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border border-gray-300'"
          class="px-4 py-1 rounded shadow text-sm hover:bg-gray-100"
        >
          <span x-text="page"></span>
        </button>
      </template>
    </div>
  </div>

<script>
function connectionsPage() {
  return {
    uid: '',
    userId: '',
    paginatedConnections: [],
    loading: false,
    fetchFailed: false,
    currentPage: 1,
    itemsPerPage: 10,
    totalPages: 1,

    initPage() {
      const urlParams = new URLSearchParams(window.location.search);
      this.uid = urlParams.get("uid") || '';
      this.userId = urlParams.get("user_id") || '';
      this.fetchAllConnections(this.currentPage);
    },

    async fetchAllConnections(page = 1) {
      this.loading = true;
      this.fetchFailed = false;

      const seenIds = new Set();
      const finalResults = [];

      let offset = (page - 1) * this.itemsPerPage;
      const batchSize = this.itemsPerPage;
      let totalCount = 0;

      try {
        while (finalResults.length < this.itemsPerPage) {
          const url = `https://n8n.sapidblue.in/webhook/Get-first-connection-list?account_id=${this.uid}&user_id=${this.userId}&offset=${offset}&limit=${batchSize}`;
          const res = await fetch(url);
          const rawData = await res.json();

          const dataArray = Array.isArray(rawData) ? rawData : rawData.connections || [];
          totalCount = rawData.total_count || totalCount || (page * batchSize);

          if (dataArray.length === 0) break;

          for (const entry of dataArray) {
            const cleaned = this.cleanObject(entry);
            if (!seenIds.has(cleaned.member_id)) {
              seenIds.add(cleaned.member_id);
              finalResults.push(cleaned);
            }
            if (finalResults.length === this.itemsPerPage) break;
          }

          offset += batchSize;
        }

        this.paginatedConnections = finalResults;
        this.totalPages = Math.ceil(totalCount / this.itemsPerPage);
        this.currentPage = page;

      } catch (e) {
        console.error("Fetch error:", e);
        this.fetchFailed = true;
      }

      this.loading = false;
    },

    goToPage(page) {
      this.fetchAllConnections(page);
    },

    clean(value) {
      if (!value) return '';
      if (typeof value === 'string') {
        return value.replace(/^"+|"+$/g, '').trim();
      }
      return value;
    },

    cleanObject(obj) {
      const cleaned = {};
      for (const key in obj) {
        cleaned[key] = this.clean(obj[key]);
      }
      return cleaned;
    }
  };
}
</script>

</body>
</html>
